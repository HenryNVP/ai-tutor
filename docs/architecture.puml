@startuml
skinparam componentStyle rectangle
skinparam wrapWidth 200
skinparam maxMessageSize 200
title Personal STEM Instructor â€“ Architecture

actor User

package "Entry Points" {
  component "CLI (`ai-tutor`)" as CLI
  component "OpenAI Agents (ingest/tutor)" as AgentRunner
  component "Python API / Notebooks" as PythonAPI
}

node "TutorSystem" as TutorSystem {
  component "Settings Loader\n& Logging" as Settings
  component "IngestionPipeline" as Ingestion
  component "TutorAgent" as TutorAgent
  component "Retriever" as Retriever
  component "EmbeddingClient" as EmbeddingClient
  component "SearchTool" as SearchTool
  component "VectorStore\n(SimpleVectorStore)" as VectorStore
  component "ChunkJsonlStore" as ChunkStore
  component "Parsers" as Parsers
  component "Chunker" as Chunker
}

database "Vector Store Files\n(data/vector_store)" as VectorFS
database "Chunks Index\n(data/processed/chunks.jsonl)" as ChunkFS
folder "Raw Documents\n(data/raw)" as RawDocs
cloud "OpenAI Agents Runtime" as OpenAIAgents
cloud "Embedding Provider\n(sentence-transformers / optional API)" as EmbeddingProvider

User --> CLI
User --> AgentRunner
User --> PythonAPI

CLI --> Ingestion : `ingest` command
CLI --> TutorAgent : `ask` command
AgentRunner --> Ingestion : ingest_corpus tool
AgentRunner --> TutorAgent : answer_question tool
PythonAPI --> Ingestion : direct ingestion call
PythonAPI --> TutorAgent : answer_question

Ingestion --> Parsers : discover & parse files
Parsers --> RawDocs : read supported documents
Ingestion --> Chunker : create overlapping chunks
Chunker --> Ingestion : chunk metadata + text
Chunker --> EmbeddingClient : request embeddings
EmbeddingClient --> EmbeddingProvider : fetch vectors
EmbeddingClient --> Ingestion : chunk embeddings
Ingestion --> VectorStore : add embeddings
VectorStore --> VectorFS : persist embeddings.npy + metadata.json
Ingestion --> ChunkStore : upsert chunk JSONL
ChunkStore --> ChunkFS : persist chunks.jsonl

TutorAgent --> Retriever : retrieve local evidence
Retriever --> EmbeddingClient : embed query
Retriever --> VectorStore : cosine search
TutorAgent --> SearchTool : web fallback
TutorAgent --> OpenAIAgents : orchestrate multi-agent workflow

note right of Ingestion
  1. Parse PDFs/Markdown/TXT via Parsers
  2. Chunk content with Chunker
  3. Embed and persist to VectorStore + ChunkStore
end note

note right of TutorAgent
  Routes between ingestion, local QA, and web-search agents,
  streaming answers while enforcing citation policy.
end note

@enduml
