@startuml
skinparam componentStyle rectangle
skinparam wrapWidth 200
skinparam maxMessageSize 200
title AI Tutor – Agent-First Architecture (v2.0)

actor User

package "Entry Points" {
  component "Streamlit UI\n(apps/ui.py)" as UI
  component "CLI (`ai-tutor`)" as CLI
  component "Python API" as PythonAPI
}

node "TutorSystem" as TutorSystem {
  component "Settings Loader\n& Logging" as Settings
  component "IngestionPipeline" as Ingestion
  component "Orchestrator Agent\n(tutor_orchestrator)" as Orchestrator
  component "QA Agent\n(qa_agent)" as QA
  component "Web Agent\n(web_agent)" as Web
  component "Ingestion Agent\n(ingestion_agent)" as IngestionAgent
  component "Retriever" as Retriever
  component "EmbeddingClient" as EmbeddingClient
  component "SearchTool" as SearchTool
  component "VectorStore\n(with source filtering)" as VectorStore
  component "ChunkJsonlStore" as ChunkStore
  component "QuizService" as QuizService
  component "ProgressTracker" as ProgressTracker
  component "PersonalizationManager" as Personalizer
  component "Parsers" as Parsers
  component "Chunker" as Chunker
}

database "Vector Store\n(data/vector_store)" as VectorFS
database "Chunks Index\n(data/processed/chunks.jsonl)" as ChunkFS
database "Learner Profiles\n(data/processed/profiles/*.json)" as ProfileFS
database "Session History\n(data/processed/sessions.sqlite)" as SessionFS
folder "Raw Documents\n(data/raw)" as RawDocs
cloud "OpenAI API\n(gpt-4o-mini)" as OpenAI
cloud "Embedding Provider\n(sentence-transformers)" as EmbeddingProvider

User --> UI : Chat interface
User --> CLI
User --> PythonAPI

UI --> Orchestrator : Natural language\n"create 20 quizzes"
UI --> Ingestion : Upload PDFs
CLI --> Ingestion : `ingest` command
CLI --> Orchestrator : `ask` command
PythonAPI --> TutorSystem : all operations

Ingestion --> Parsers : parse PDFs/Markdown
Parsers --> RawDocs : read documents
Ingestion --> Chunker : create chunks
Chunker --> EmbeddingClient : embed chunks
EmbeddingClient --> EmbeddingProvider : generate vectors
Ingestion --> VectorStore : store embeddings
VectorStore --> VectorFS : persist .npy + metadata
Ingestion --> ChunkStore : save chunks
ChunkStore --> ChunkFS : persist .jsonl

Orchestrator --> QA : STEM questions
Orchestrator --> Web : current events/non-STEM
Orchestrator --> IngestionAgent : file uploads
Orchestrator --> QuizService : generate_quiz tool
Orchestrator --> SessionFS : maintain context

QA --> Retriever : retrieve_local_context
Retriever --> EmbeddingClient : embed query
Retriever --> VectorStore : cosine search\n+ source filter
Web --> SearchTool : web_search

QuizService --> Retriever : find relevant content\n(with source filtering)
QuizService --> OpenAI : generate questions\n(dynamic max_tokens)
QuizService --> ProgressTracker : update profiles
ProgressTracker --> ProfileFS : save learner data
ProgressTracker --> Personalizer : track mastery

Orchestrator --> OpenAI : stream responses
QA --> OpenAI : generate cited answers
Web --> OpenAI : synthesize web results

note right of Orchestrator
  Agent-First Architecture:
  • Routes via natural language understanding
  • Extracts count & topic from user messages
  • Calls generate_quiz as function tool
  • NEVER answers quiz requests with text
  • Supports "create 20 quizzes from documents"
  
  Daily session rotation prevents token overflow
end note

note right of QuizService
  NEW Features (v2.0):
  1. Generate 3-40 questions (was 3-8)
  2. Dynamic max_tokens calculation:
     tokens = (num_questions × 150) + 500
  3. Source filtering for uploaded docs
  4. Topic inference from context
  5. Called as agent tool (not UI button)
  
  Profile Updates by Score:
  • ≥70%: +strength, advance difficulty
  • 40-69%: moderate adjustment
  • <40%: +struggle, easier difficulty
end note

note left of VectorStore
  NEW: Source Filtering (v2.0)
  • Can search ONLY specific files
  • 320x faster for uploaded docs
  • Pre-filters by filename before similarity
  • Guarantees relevance to user uploads
  
  Semantic search with cosine similarity
  Optional source_filter parameter
end note

note bottom of UI
  Two Tabs:
  1. Chat & Learn (upload, quiz, Q&A)
  2. Corpus Management (browse docs)
  
  Quiz Builder tab REMOVED (v2.0)
  Use natural language instead!
end note

@enduml
